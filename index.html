<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Code doodling (1)</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
    <style>
        #imgHolder, #triHolder, #eacHolder, #curHolder{
            position: absolute;
         
        }
    </style>
    
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.0.0.min.js"></script>
    <script>if (!window.jQuery) { document.write('<script src="scripts/jquery-3.0.0.min.js"><\/script>'); }</script>
</head>
<body>
    <script>
        var clicked = false;
        var eachClicked = false;
        var imgContext;
        var triContext;
        var curContext;
        var eacContext;
        var MAR_ = 40;
        var STR_ = 20;
        var WI_;
        var HI_;
        var tri = [];
        var poi = [];
        var waypoi = [];
        var allTri = [];
        var currPoi = [];
        var MIN_DIS_ = 4;
        var RATE_ = 0.1;
        var GAP_ = 50;
        var t;

        $(document).ready(function () {
            setit();
            $(window).resize(function (event) {
                if (!clicked)
                    setit();
            });

            curHolder.addEventListener("mousemove", mousemove);

            curHolder.addEventListener("click", click);
        });

        function mousemove(e) {
            curContext.clearRect(currPoi[0], currPoi[1], STR_, STR_);
            currPoi = getCoor(e);
            curContext.fillRect(currPoi[0], currPoi[1], STR_, STR_);

            if (eachClicked) {
                eacContext.clearRect(0, 0, WI_, HI_);
                eacContext.beginPath();
                eacContext.moveTo(tri[0][0], tri[0][1]);
                for (var i = 1; i < tri.length; i++) {
                    eacContext.lineTo(tri[i][0], tri[i][1]);
                }
                eacContext.lineTo(currPoi[0], currPoi[1]);
                eacContext.stroke();
            }
        }

        function click(e) {
            if (tri[0] == currPoi) {
                tri.push(currPoi);
                t = 1;
                calcwayPoi1();
                calcwayPoi2();
                animate();
                triContext.clearRect(0, 0, WI_, HI_);
                eacContext.clearRect(0, 0, WI_, HI_);
                tri = [];
                eachClicked = false;
                return;
            }
            if (tri[tri.length - 1] == currPoi) {
                tri.splice(tri.length - 1, 1);
                imgContext.clearRect(currPoi[0], currPoi[1], STR_, STR_);
                triContext.clearRect(currPoi[0], currPoi[1], STR_, STR_);
                return;
            }
            clicked = true;
            eachClicked = true;
            tri.push(currPoi);
            poi.push(currPoi);
            imgContext.fillRect(currPoi[0], currPoi[1], STR_, STR_);
            triContext.fillRect(currPoi[0], currPoi[1], STR_, STR_);
        }


        function calcwayPoi1() {
            allTri = tri.slice();
            while (distancesEnough()) {
                var med = findMed(allTri[allTri.length - tri.length + 1], allTri[allTri.length - tri.length + 2]);
                allTri.push(med);
            }
        }

        function calcwayPoi2() {
            waypoi = [];
            for (var i = 1; i < allTri.length; i++) {
                var pt0 = allTri[i - 1];
                var pt1 = allTri[i];
                var dx = pt1[0] - pt0[0];
                var dy = pt1[1] - pt0[1];
		if (Math.abs(dx) > Math.abs(dy)) {
			if (dx > 0) {
				for (var j = 0; j < dx; j = j + GAP_) {
					var x = pt0[0] + j;
					var y = pt0[1] + j / dx * dy;
					waypoi.push([x, y]);
				}
			}
			else {
				for (var j = 0; j > dx; j = j - GAP_) {
					var x = pt0[0] + j;
					var y = pt0[1] + j / dx * dy;
					waypoi.push([x, y]);
				}
			}
		}
		else {
			if (dy > 0) {
				for (var j = 0; j < dy; j = j + GAP_) {
				    var y = pt0[1] + j;
				    var x = pt0[0] + j / dy * dx;
				    waypoi.push([x, y]);
				}
			}
			else {
				for (var j = 0; j > dy; j = j - GAP_) {
				    var y = pt0[1] + j;
				    var x = pt0[0] + j / dy * dx;
				    waypoi.push([x, y]);
				}
			}
		}
          }
        }
        

        function animate() {
            if (t < waypoi.length - 1) {
                requestAnimationFrame(animate);
            }
            imgContext.beginPath();
            imgContext.moveTo(waypoi[t - 1][0], waypoi[t - 1][1]);
            imgContext.lineTo(waypoi[t][0], waypoi[t][1]);
            imgContext.stroke();
            t++;
        }

        function distancesEnough() {
            for (var i = allTri.length - tri.length; i < allTri.length - 1; i++) {
                if (distance(allTri[i], allTri[i + 1]) < MIN_DIS_)
                    return false;
            }
            return true;
        }

        function distance(pA, pB)
        {
            var x = (pA[0] - pB[0]) * (pA[0] - pB[0]);
            var y = (pA[1] - pB[1]) * (pA[1] - pB[1]);
            return  Math.sqrt(x + y);
        }

        function findMed(pA, pB) {
            var x = (pB[0] - pA[0]) * RATE_ + pA[0];
            var y = (pB[1] - pA[1]) * RATE_ + pA[1];
            return [x, y];
        }

        function getCoor(e) {
            var screenCoor = getScreenCoor(e);
            return getRealCoor(screenCoor);
        }

        function getScreenCoor(e) {
            var x;
            var y;
            if (e.pageX || e.pageY) {
                x = e.pageX;
                y = e.pageY;
            }
            else {
                x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
                y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
            }
            x -= curHolder.offsetLeft;
            y -= curHolder.offsetTop;
            return [x, y];
        }

        function getRealCoor(screenCoor) {
            var x = screenCoor[0];
            var y = screenCoor[1];

            if (x < MAR_ * 2) x = MAR_;
            if (y < MAR_ * 2) y = MAR_;
            if (x > WI_ - MAR_ * 2 - STR_) x = WI_ - MAR_ - STR_;
            if (y > HI_ - MAR_ * 2 - STR_) y = HI_ - MAR_ - STR_;
            for (var i = 0; i < poi.length; i++) {
                if (rectDistance(x, y, poi[i]) < MAR_) {
                    return poi[i];
                }
            }


            return [x, y];
        }

        function rectDistance(x, y, thePoint) {
            return Math.max(Math.abs(thePoint[0] - x), Math.abs(thePoint[1] - y));
        }

        function setit() {
            WI_ = $(window).width() - 20;
            HI_ = $(window).height() - 60;

            imgHolder.width = WI_;
            imgHolder.height = HI_;
            triHolder.width = WI_;
            triHolder.height = HI_;
            eacHolder.width = WI_;
            eacHolder.height = HI_;
            curHolder.width = WI_;
            curHolder.height = HI_;

            imgContext = imgHolder.getContext('2d');
            triContext = triHolder.getContext('2d');
            eacContext = eacHolder.getContext('2d');
            curContext = curHolder.getContext('2d');

            //imgContext.fillStyle = "rgba(200, 200, 200, 255)";
            //imgContext.fillRect(0, 0, WI_, HI_);
            imgContext.lineWidth = 2
            triContext.fillStyle = "rgba(222, 222, 22, 255)";
            eacContext.strokeStyle = "rgba(22, 222, 22, 255)";
            eacContext.lineWidth = 4;
            curContext.fillStyle = "rgba(22, 222, 22, 255)";

            var gra = imgContext.createLinearGradient(0, 0, WI_, HI_);
            gra.addColorStop(0, "rgba(222, 0, 22, 255)");
            gra.addColorStop(1, "rgba(22, 0, 222, 255)");
            imgContext.fillStyle = gra;

            // imgContext.beginPath();
            imgContext.moveTo(MAR_, MAR_);
            imgContext.lineTo(MAR_, HI_ - MAR_);
            imgContext.lineTo(WI_ - MAR_, HI_ - MAR_);
            imgContext.lineTo(WI_ - MAR_, MAR_);
            imgContext.lineTo(MAR_, MAR_);
            imgContext.stroke();
        }

        function onlick()
        {
            clicked = true;
        }
    </script>

    <canvas id="imgHolder"></canvas>
    <canvas id="triHolder"></canvas>
    <canvas id="eacHolder"></canvas>
    <canvas id="curHolder"></canvas>
</body>
</html>
